name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build the stack
        run: docker compose build

      - name: Run the stack
        run: docker compose up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services..."
          sleep 15
          docker compose ps -a

      - name: Show logs if startup failed
        if: failure()
        run: |
          echo "========== docker compose ps -a =========="
          docker compose ps -a
          echo "========== all services logs =========="
          docker compose logs --tail=100

      - name: Run API Gateway tests
        run: docker compose exec -T api-gateway npm test || true
        continue-on-error: true

      - name: Run Auth Service tests
        run: docker compose exec -T auth-service npm test || true
        continue-on-error: true

      - name: Run Movies Service tests
        run: docker compose exec -T movies-service npm test || true
        continue-on-error: true

      - name: Run Payment Service tests
        run: docker compose exec -T payment-service npm test || true
        continue-on-error: true

      - name: Show test results
        if: always()
        run: docker compose logs --tail=200

      - name: Down the stack
        if: always()
        run: docker compose down -v
